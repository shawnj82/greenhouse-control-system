<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lights Configuration - Crane Creek Greenhouse</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .control-fields {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .control-fields label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .control-fields small {
            color: #6c757d;
            font-style: italic;
            display: block;
            margin-top: 3px;
        }
        .control-fields input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        .control-fields .form-row {
            display: flex;
            gap: 15px;
        }
        .control-fields .form-row .form-group {
            flex: 1;
        }
        .hardware-controls {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 10px 15px;
            margin: 15px 0;
        }
        .hardware-controls h4 {
            margin-top: 0;
            color: #007bff;
        }
    </style>
</head>
<body>
    <header>
        <h1>ðŸ’¡ Lights Configuration</h1>
        <nav>
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/zones" class="nav-link">Zones</a>
            <a href="/lights" class="nav-link active">Lights</a>
            <a href="/calibration" class="nav-link">Calibration</a>
            <a href="/settings" class="nav-link">Settings</a>
        </nav>
    </header>

    <main>
        <section class="lights-config">
            <h2>Light Fixtures Management</h2>
            <p>Configure your greenhouse lighting system with precise positioning and specifications.</p>
            
            <div class="lights-controls">
                <button onclick="addNewLight()" class="btn btn-success">Add New Light</button>
                <button onclick="saveLights()" class="btn btn-primary">Save Configuration</button>
            </div>

            <div class="lights-grid-preview">
                <h3>Grid Preview with Lights</h3>
                <div class="layer-controls">
                    <label class="layer-toggle">
                        <input type="checkbox" id="showLightFixtures" checked>
                        <span class="checkmark"></span>
                        Show Lights
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" id="showZonesPreview" checked>
                        <span class="checkmark"></span>
                        Show Zones
                    </label>
                </div>
                
                <div id="greenhouse-grid" class="grid-container">
                    <!-- Grid will be populated by JavaScript -->
                    <div id="lights-overlay" class="lights-overlay">
                        <!-- Light fixtures will be rendered here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Light Sensors Management -->
        <section class="light-sensors">
            <h2>Light Sensors</h2>
            <p>Configure light sensors, their connection to Raspberry Pi, and the zone they monitor.</p>

            <div class="lights-controls">
                <button onclick="addNewLightSensor()" class="btn btn-success">Add New Sensor</button>
                <button onclick="saveLightSensors()" class="btn btn-primary">Save Sensors</button>
            </div>

            <div id="lightSensorsTable"></div>
        </section>

        <!-- Light Configuration Panel -->
        <section class="light-details" id="lightDetails" style="display: none;">
            <h3>Configure Light <span id="selectedLight"></span></h3>
            <form id="lightForm">
                <div class="form-group">
                    <label for="lightName">Light Name:</label>
                    <input type="text" id="lightName" placeholder="e.g., Main LED Panel 1">
                </div>
                
                <div class="form-group">
                    <label for="lightType">Light Type:</label>
                    <select id="lightType">
                        <option value="LED Panel">LED Panel</option>
                        <option value="T5 Fluorescent">T5 Fluorescent</option>
                        <option value="T8 Fluorescent">T8 Fluorescent</option>
                        <option value="HPS">High Pressure Sodium</option>
                        <option value="MH">Metal Halide</option>
                        <option value="CFL">Compact Fluorescent</option>
                        <option value="Strip Light">LED Strip</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>

                <!-- Hardware Control Configuration -->
                <div class="form-group">
                    <label for="controlType">Hardware Control:</label>
                    <select id="controlType" onchange="updateControlFields()">
                        <option value="none">No Hardware Control (Software Only)</option>
                        <option value="gpio">GPIO On/Off Control</option>
                        <option value="pwm">PWM Dimming Control</option>
                        <option value="rgb">RGB LED Control (3-pin)</option>
                        <option value="i2c">I2C Device Control</option>
                    </select>
                </div>

                <!-- GPIO Control Fields -->
                <div id="gpioControls" class="control-fields" style="display: none;">
                    <div class="form-group">
                        <label for="gpioPin">GPIO Pin:</label>
                        <input type="number" id="gpioPin" min="2" max="27" placeholder="e.g., 18">
                        <small>BCM pin number for on/off control</small>
                    </div>
                    <div class="form-group">
                        <label style="display:flex; align-items:center; gap:8px; font-weight:normal;">
                            <input type="checkbox" id="gpioActiveLow">
                            Invert (active low)
                        </label>
                        <small>If your relay or driver turns ON when the pin is LOW, enable this.</small>
                    </div>
                </div>

                <!-- PWM Control Fields -->
                <div id="pwmControls" class="control-fields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pwmPin">PWM Pin:</label>
                            <input type="number" id="pwmPin" min="2" max="27" placeholder="e.g., 18">
                        </div>
                        <div class="form-group">
                            <label for="pwmFrequency">Frequency (Hz):</label>
                            <input type="number" id="pwmFrequency" min="100" max="10000" value="1000">
                        </div>
                    </div>
                </div>

                <!-- RGB Control Fields -->
                <div id="rgbControls" class="control-fields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="redPin">Red Pin:</label>
                            <input type="number" id="redPin" min="2" max="27" placeholder="e.g., 18">
                        </div>
                        <div class="form-group">
                            <label for="greenPin">Green Pin:</label>
                            <input type="number" id="greenPin" min="2" max="27" placeholder="e.g., 19">
                        </div>
                        <div class="form-group">
                            <label for="bluePin">Blue Pin:</label>
                            <input type="number" id="bluePin" min="2" max="27" placeholder="e.g., 20">
                        </div>
                    </div>
                </div>

                <!-- I2C Control Fields -->
                <div id="i2cControls" class="control-fields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="i2cAddress">I2C Address:</label>
                            <input type="text" id="i2cAddress" placeholder="e.g., 0x40">
                        </div>
                        <div class="form-group">
                            <label for="i2cBus">I2C Bus:</label>
                            <input type="number" id="i2cBus" min="0" max="1" value="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="i2cDevice">Device Type:</label>
                        <input type="text" id="i2cDevice" placeholder="e.g., PCA9685, MCP23017">
                        <small>Device type for reference</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="lightWidth">Width (inches):</label>
                        <input type="number" id="lightWidth" min="1" max="120" value="24">
                    </div>
                    <div class="form-group">
                        <label for="lightDepth">Depth (inches):</label>
                        <input type="number" id="lightDepth" min="1" max="120" value="12">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="lightPower">Power (watts):</label>
                        <input type="number" id="lightPower" min="1" max="1000" value="100">
                    </div>
                    <div class="form-group">
                        <label for="dimmingLevel">Dimming (%):</label>
                        <input type="number" id="dimmingLevel" min="0" max="100" value="100">
                    </div>
                </div>

                <div class="form-group">
                    <label>Grid Position:</label>
                    <div class="position-controls">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="positionRow">Row:</label>
                                <input type="number" id="positionRow" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="positionCol">Column:</label>
                                <input type="number" id="positionCol" min="0" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rowSpan">Row Span:</label>
                                <input type="number" id="rowSpan" min="1" value="1">
                            </div>
                            <div class="form-group">
                                <label for="colSpan">Column Span:</label>
                                <input type="number" id="colSpan" min="1" value="2">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Light Spectrum:</label>
                    <div class="spectrum-controls">
                        <div class="spectrum-input">
                            <label for="lightRedPercent">Red (%):</label>
                            <input type="number" id="lightRedPercent" min="0" max="100" value="40" class="spectrum-slider">
                        </div>
                        <div class="spectrum-input">
                            <label for="lightBluePercent">Blue (%):</label>
                            <input type="number" id="lightBluePercent" min="0" max="100" value="20" class="spectrum-slider">
                        </div>
                        <div class="spectrum-input">
                            <label for="lightWhitePercent">White (%):</label>
                            <input type="number" id="lightWhitePercent" min="0" max="100" value="40" class="spectrum-slider">
                        </div>
                        <div class="spectrum-total">
                            Total: <span id="lightSpectrumTotal">100</span>%
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="lightNotes">Notes:</label>
                    <textarea id="lightNotes" rows="3" placeholder="Installation notes, control details..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" onclick="applyLightConfig()" class="btn btn-success">Apply</button>
                    <button type="button" onclick="deleteLight()" class="btn btn-danger">Delete Light</button>
                    <button type="button" onclick="closeLightConfig()" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </section>

        <!-- Lights List -->
        <section class="lights-list">
            <h3>Current Light Fixtures</h3>
            <div id="lightsTable">
                <!-- Will be populated by JavaScript -->
            </div>
        </section>
    </main>

    <script>
        window.userSettings = {{ user_settings | tojson }};
    </script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
    // Initialize page globals using strings to avoid static analysis errors
    // Assign into existing global bindings so app.js functions see the same objects
    currentLights = JSON.parse('{{ lights | tojson | safe }}');
    currentZones = JSON.parse('{{ zones | tojson | safe }}');
        window.selectedLightKey = null;
        // Ensure sensors object exists; will be populated by loadLightSensors()
        window.currentLightSensors = window.currentLightSensors || { config: { sensors: {} }, readings: {} };

        document.addEventListener('DOMContentLoaded', function() {
            // Set initial grid size from zones data
            gridSize = currentZones.grid_size || { rows: 4, cols: 6 };
            
            // Load grid and lights
            renderGrid(false); // Not editable on lights page
            renderLightsOverlay();
            renderLightsTable();
            loadLightSensors();
            
            // Add spectrum input listeners
            const lightSpectrumInputs = ['lightRedPercent', 'lightBluePercent', 'lightWhitePercent'];
            lightSpectrumInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', updateLightSpectrumTotal);
                    input.addEventListener('change', updateLightSpectrumTotal);
                }
            });
            
            // Add layer toggle listeners
            const showLightFixtures = document.getElementById('showLightFixtures');
            const showZonesPreview = document.getElementById('showZonesPreview');
            
            if (showLightFixtures) {
                showLightFixtures.addEventListener('change', function() {
                    renderLightsOverlay();
                });
            }
            
            if (showZonesPreview) {
                showZonesPreview.addEventListener('change', function() {
                    const gridCells = document.querySelectorAll('.grid-cell');
                    gridCells.forEach(cell => {
                        cell.style.display = this.checked ? 'flex' : 'none';
                    });
                });
            }
        });

        // Hardware Control Field Management
        function updateControlFields() {
            const controlType = document.getElementById('controlType').value;
            
            // Hide all control field sections
            const controlSections = ['gpioControls', 'pwmControls', 'rgbControls', 'i2cControls'];
            controlSections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
            
            // Show relevant control fields
            if (controlType === 'gpio') {
                document.getElementById('gpioControls').style.display = 'block';
            } else if (controlType === 'pwm') {
                document.getElementById('pwmControls').style.display = 'block';
            } else if (controlType === 'rgb') {
                document.getElementById('rgbControls').style.display = 'block';
            } else if (controlType === 'i2c') {
                document.getElementById('i2cControls').style.display = 'block';
            }
        }

        // Control individual lights via hardware
        function controlLight(lightId, action, value = 100) {
            const payload = { action: action };
            if (action === 'dim' || action === 'color') {
                payload.value = value;
            }
            
            fetch(`/api/lights/${lightId}/control`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message || `Light ${action} successful`, 'success');
                    renderLightsOverlay(); // Refresh display
                    renderLightsTable();
                } else {
                    showNotification(`Light control failed: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showNotification(`Control error: ${error}`, 'error');
                console.error('Light control error:', error);
            });
        }

        function loadLightSensors() {
            fetch('/api/light-sensors').then(r => r.json()).then(data => {
                currentLightSensors = data || { config: { sensors: {} }, readings: {} };
                renderLightSensorsTable();
            }).catch(err => console.error('Failed to load light sensors', err));
        }

        function renderLightSensorsTable(forceRebuild = false) {
            const container = document.getElementById('lightSensorsTable');
            const sensors = currentLightSensors?.config?.sensors || {};
            
            // Check if table already exists and we can just update readings
            const existingTable = container.querySelector('table');
            if (existingTable && !forceRebuild) {
                updateSensorReadings();
                return;
            }
            
            // Full table rebuild (when table doesn't exist or forceRebuild is true)
            const rows = Object.entries(sensors).map(([id, s]) => `
                <tr data-sensor-id="${id}">
                    <td><input value="${s.name || ''}" data-field="name"/></td>
                    <td>
                        <select data-field="type" value="${s.type || 'BH1750'}">
                            <option value="BH1750" ${s.type==='BH1750'?'selected':''}>BH1750</option>
                            <option value="TSL2561" ${s.type==='TSL2561'?'selected':''}>TSL2561</option>
                            <option value="TSL2591" ${s.type==='TSL2591'?'selected':''}>TSL2591</option>
                            <option value="VEML7700" ${s.type==='VEML7700'?'selected':''}>VEML7700</option>
                            <option value="TCS34725" ${s.type==='TCS34725'?'selected':''}>TCS34725</option>
                        </select>
                    </td>
                    <td>
                        Bus: <input type="number" min="0" style="width:70px" value="${(s.connection&&s.connection.bus)!=null?s.connection.bus:1}" data-field="bus"/>
                        Addr: <input type="number" min="0" max="127" style="width:70px" value="${(s.connection&&s.connection.address)!=null?s.connection.address:35}" data-field="address"/><br/>
                        Mux Addr: <input type="number" min="0" max="127" style="width:70px" value="${(s.connection&&s.connection.mux_address)!=null?s.connection.mux_address:''}" data-field="mux_address" placeholder="Optional"/>
                        Ch: <input type="number" min="0" max="7" style="width:50px" value="${(s.connection&&s.connection.mux_channel)!=null?s.connection.mux_channel:''}" data-field="mux_channel" placeholder="0-7"/>
                    </td>
                    <td>
                        Zone:
                        <select data-field="zone_key">
                            ${getZoneOptions(s.zone_key)}
                        </select>
                    </td>
                    <td>
                        <input type="number" step="0.001" min="0" style="width:80px" value="${s.scaling_factor!=null?s.scaling_factor:1.0}" data-field="scaling_factor"/>
                    </td>
                    <td>
                        <input type="number" step="0.0001" min="0" style="width:90px" 
                            value="${(s.lux_calibration!=null)?s.lux_calibration:((s.calibration_factor!=null)?s.calibration_factor:(s.type==='TCS34725'?0.3545:1.0))}" 
                            data-field="lux_calibration"/>
                    </td>
                    <td class="reading-cell">
                        <span>${getLuxReading(currentLightSensors.readings, id)}</span>
                    </td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteLightSensor('${id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th><th>Type</th><th>Connection</th><th>Zone</th><th>Scaling Factor</th><th>Lux Calibration</th><th>Reading</th><th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows || '<tr><td colspan="8">No sensors configured</td></tr>'}
                    </tbody>
                </table>
            `;
        }

        function updateSensorReadings() {
            // Update only the reading cells without rebuilding the table
            const tbody = document.querySelector('#lightSensorsTable tbody');
            if (!tbody) return;
            
            tbody.querySelectorAll('tr').forEach(tr => {
                const sensorId = tr.getAttribute('data-sensor-id');
                const readingCell = tr.querySelector('.reading-cell span');
                if (readingCell && sensorId) {
                    readingCell.innerHTML = getLuxReading(currentLightSensors.readings, sensorId);
                }
            });
        }

        window.addNewLightSensor = function() {
            const id = `ls-${Date.now()}`;
            if (!currentLightSensors.config) currentLightSensors.config = { sensors: {} };
            if (!currentLightSensors.config.sensors) currentLightSensors.config.sensors = {};
            currentLightSensors.config.sensors[id] = {
                name: 'New Sensor',
                type: 'BH1750',
                connection: { bus: 1, address: 35 },
                zone_key: 'unassigned',  // Changed from '' to 'unassigned'
                scaling_factor: 1.0,
                lux_calibration: 1.0,
                notes: ''
            };
            renderLightSensorsTable(true);  // Force rebuild to show new sensor
        }

        window.deleteLightSensor = function(id) {
            if (currentLightSensors?.config?.sensors && currentLightSensors.config.sensors[id]) {
                delete currentLightSensors.config.sensors[id];
                renderLightSensorsTable(true);  // Force rebuild to remove deleted sensor
            }
        }

        window.saveLightSensors = function() {
            // Read values back from the table
            const tbody = document.querySelector('#lightSensorsTable tbody');
            if (!tbody) return;
            const sensors = {};
            tbody.querySelectorAll('tr').forEach(tr => {
                const id = tr.getAttribute('data-sensor-id');
                const get = sel => tr.querySelector(sel);
                const name = get('input[data-field="name"]').value;
                const type = get('select[data-field="type"]').value;
                const bus = parseInt(get('input[data-field="bus"]').value, 10);
                const address = parseInt(get('input[data-field="address"]').value, 10);
                const zone_key = get('select[data-field="zone_key"]').value;
                const scaling_factor = parseFloat(get('input[data-field="scaling_factor"]').value) || 1.0;
                const lux_calibration = parseFloat(get('input[data-field="lux_calibration"]').value);
                
                // Read mux fields (optional)
                const mux_address_str = get('input[data-field="mux_address"]').value;
                const mux_channel_str = get('input[data-field="mux_channel"]').value;
                
                const connection = { bus, address };
                if (mux_address_str !== '') {
                    connection.mux_address = parseInt(mux_address_str, 10);
                }
                if (mux_channel_str !== '') {
                    connection.mux_channel = parseInt(mux_channel_str, 10);
                }
                
                sensors[id] = {
                    name, type,
                    connection,
                    zone_key,
                    scaling_factor,
                    ...(isNaN(lux_calibration) ? {} : { lux_calibration })
                };
            });
            const payload = { sensors };
            fetch('/api/light-sensors', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(res => {
                if (res.success) {
                    loadLightSensors();
                    alert('Light sensors saved');
                    // Re-render overlays in case readings updated
                    renderLightsOverlay();
                } else {
                    alert('Failed to save sensors: ' + (res.error || 'unknown'));
                }
            }).catch(err => alert('Failed to save sensors: ' + err));
        }

        function getLuxReading(readings, sensorId) {
            if (!readings || !readings[sensorId]) return 'â€”';
            const reading = readings[sensorId];
            
            // Check for error first
            if (reading.error) {
                return '<span style="color: #f44336;">Error</span>';
            }
            
            // New format: light_metrics.lux.value
            const lightMode = (window.userSettings && window.userSettings.light_unit ? window.userSettings.light_unit : 'lux').toLowerCase();
            if (lightMode === 'par' && reading.light_metrics && reading.light_metrics.PPFD && reading.light_metrics.PPFD.value != null) {
                return Math.round(reading.light_metrics.PPFD.value) + ' Âµmol';
            }
            if (reading.light_metrics && reading.light_metrics.lux && reading.light_metrics.lux.value != null) {
                return Math.round(reading.light_metrics.lux.value) + ' lux';
            }
            
            // Old format: lux (fallback)
            if (reading.lux != null) {
                return Math.round(reading.lux) + ' lux';
            }
            
            return 'â€”';
        }

        function getZoneOptions(selected) {
            const size = currentZones?.grid_size || { rows: 4, cols: 6 };
            const options = ['<option value="unassigned" ' + (selected==='unassigned'?'selected':'') + '>Unassigned</option>'];
            for (let r = 0; r < size.rows; r++) {
                for (let c = 0; c < size.cols; c++) {
                    const key = `${r}-${c}`;
                    const zoneName = currentZones?.zones?.[key]?.crop_type || `Cell ${r+1},${c+1}`;
                    options.push(`<option value="${key}" ${selected===key?'selected':''}>${zoneName} (${key})</option>`);
                }
            }
            return options.join('');
        }
    </script>
</body>
</html>