<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crane Creek Greenhouse</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>üå± Crane Creek Greenhouse Control</h1>
        <nav>
            <a href="/" class="nav-link active">Dashboard</a>
            <a href="/zones" class="nav-link">Zones</a>
            <a href="/settings" class="nav-link">Settings</a>
            <a href="/lights" class="nav-link">Lights</a>
            <a href="/calibration" class="nav-link">Calibration</a>
            <a href="/settings" class="nav-link">Settings</a>
        </nav>
    </header>

    <main>

    <script>
        window.userSettings = {{ user_settings | tojson }};
    </script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
        <!-- Status Overview -->
        <section class="status-overview">
            <h2>Current Status</h2>
            <div class="status-grid">
                <div class="status-card">
                    <h3>üå°Ô∏è Temperature</h3>
                    <div class="status-value">
                        {% if status.temperature_c %}
                            {{ "%.1f"|format(status.temperature_c) }}¬∞C
                        {% else %}
                            --
                        {% endif %}
                    </div>
                </div>
                <div class="status-card">
                    <h3>üíß Humidity</h3>
                    <div class="status-value">
                        {% if status.humidity %}
                            {{ "%.1f"|format(status.humidity) }}%
                        {% else %}
                            --
                        {% endif %}
                    </div>
                </div>
                <div class="status-card">
                    <h3>‚òÄÔ∏è Light</h3>
                    <div class="status-value">
                        {% if status.light_lux %}
                            {{ "%.0f"|format(status.light_lux) }} lux
                        {% else %}
                            --
                        {% endif %}
                    </div>
                </div>
                <div class="status-card">
                    <h3>üå± Soil</h3>
                    <div class="status-value">
                        {% if status.soil_moisture %}
                            {{ "%.0f"|format(status.soil_moisture) }}%
                        {% else %}
                            --
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <!-- Device Controls -->
        <section class="device-controls">
            <h2>Device Controls</h2>
            <div class="controls-grid">
                <div class="control-card">
                    <h3>üí° Grow Light</h3>
                    <button onclick="controlDevice('grow_light', 'on')" class="btn btn-on">ON</button>
                    <button onclick="controlDevice('grow_light', 'off')" class="btn btn-off">OFF</button>
                </div>
                <div class="control-card">
                    <h3>üî• Heater</h3>
                    <button onclick="controlDevice('heater', 'on')" class="btn btn-on">ON</button>
                    <button onclick="controlDevice('heater', 'off')" class="btn btn-off">OFF</button>
                </div>
                <div class="control-card">
                    <h3>üå™Ô∏è Fan</h3>
                    <input type="range" id="fanSpeed" min="0" max="100" value="0" onchange="controlFan(this.value)">
                    <span id="fanSpeedValue">0%</span>
                </div>
            </div>
        </section>

        <!-- Greenhouse Grid Preview -->
        <section class="greenhouse-preview">
            <h2>Greenhouse Layout</h2>
            
            <div class="layer-controls">
                <label class="layer-toggle">
                    <input type="checkbox" id="showLightFixtures" checked>
                    <span class="checkmark"></span>
                    Show Light Fixtures
                </label>
                <label class="layer-toggle">
                    <input type="checkbox" id="showLightAmount">
                    <span class="checkmark"></span>
                    Show Light Amount
                </label>
                <!-- PPFD/Lux toggle moved to global Settings page -->
                <label class="layer-toggle">
                    <input type="checkbox" id="showSensorMarkers" checked>
                    <span class="checkmark"></span>
                    Show Sensor Markers
                </label>
                <label class="layer-toggle" title="Zones are always shown">
                    <input type="checkbox" id="showZones" checked disabled>
                    <span class="checkmark"></span>
                    Show Zones (always on)
                </label>
                
                <!-- Estimation tuning controls -->
                <div id="estimation-controls" class="estimation-controls" title="Configure how sensor-based estimation is calculated">
                    <label class="inline">
                        <input type="checkbox" id="enableEstimation" checked>
                        <span class="checkmark"></span>
                        Estimate for non-sensor zones
                    </label>
                    <div class="estimation-inputs">
                        <label>
                            Power
                            <input type="number" id="estPower" min="1" max="6" step="0.5" value="2">
                        </label>
                        <label>
                            Max sensors
                            <input type="number" id="estMaxSensors" min="1" max="12" step="1" value="4">
                        </label>
                        <label>
                            Max distance (cells)
                            <input type="number" id="estMaxDistance" min="1" max="100" step="1" value="100">
                        </label>
                    </div>
                </div>

                <!-- Lux scaling (log) controls -->
                <div id="lux-controls" class="lux-controls" title="Tune how lux maps to brightness using a log scale">
                    <div class="lux-inputs">
                        <label>
                            Max lux
                            <input type="number" id="luxMaxLux" min="1000" max="200000" step="1000" value="100000">
                        </label>
                        <label>
                            Soft floor (L0)
                            <input type="number" id="luxSoftFloor" min="1" max="1000" step="1" value="50">
                        </label>
                        <label>
                            Gamma
                            <input type="number" id="luxGamma" min="0.5" max="4" step="0.1" value="2.0">
                        </label>
                        <label>
                            Blending (alpha)
                            <input type="range" id="luxAlpha" min="0" max="1" step="0.01" value="1" style="width:100px;">
                            <span id="luxAlphaValue">1.00</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div id="greenhouse-grid" class="grid-container">
                <!-- Grid will be populated by JavaScript -->
                <div id="lights-overlay" class="lights-overlay">
                    <!-- Light fixtures will be rendered here -->
                </div>
                <div id="sensors-overlay" class="sensors-overlay">
                    <!-- Sensor markers will be rendered here -->
                </div>
            </div>
            <a href="/zones" class="btn btn-primary">Configure Zones</a>
        </section>

        <!-- Recent Errors & Todos -->
        <div class="info-panels">
            <section class="recent-errors">
                <h2>Recent Issues</h2>
                <ul>
                    {% for error in recent_errors %}
                        <li>{{ error.timestamp }}: {{ error.message }}</li>
                    {% else %}
                        <li>No recent errors</li>
                    {% endfor %}
                </ul>
            </section>

            <section class="todos">
                <h2>Reminders</h2>
                <ul>
                    {% for todo in todos %}
                        <li>{{ todo.task }}</li>
                    {% else %}
                        <li>No pending tasks</li>
                    {% endfor %}
                </ul>
            </section>
        </div>
    </main>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        // Initialize the grid on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadGreenhouseGrid();
            
            // Get dynamic update interval from server
            fetch('/api/frontend-config')
                .then(response => response.json())
                .then(config => {
                    const interval = config.update_interval_ms;
                    console.log(`Setting status update interval to ${interval}ms`);
                    setInterval(updateStatus, interval);
                })
                .catch(error => {
                    console.error('Error getting frontend config, using default 10s:', error);
                    setInterval(updateStatus, 10000); // Fallback to 10 seconds
                });
        });
    </script>
</body>
</html>